<!doctype html>
<html lang="en" class="no-js">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	
	<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="css/reset.css"> <!-- CSS reset -->
	<link rel="stylesheet" href="css/style.css"> <!-- Resource style -->
	<script src="js/modernizr.js"></script> <!-- Modernizr -->

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  	
	<title>WHERE-LAH</title>
</head>
<body>
<header>
	<!--
	<nav class="cd-stretchy-nav add-content">
		<a class="cd-nav-trigger" href="#0">
			Menu
			<span aria-hidden="true"></span>
		</a>

		<ul>
			<li><a href="#0"><span>Image</span></a></li>
			<li><a href="#0"><span>Audio</span></a></li>
			<li><a href="#0"><span>Link</span></a></li>
			<li><a href="#0"><span>Video</span></a></li>
		</ul>

		<span aria-hidden="true" class="stretchy-nav-bg"></span>
	</nav>
	-->
</header>

<!--
https://codepen.io/nadiarasul/pen/mPvpJM
https://codepen.io/tag/bus/

-->

<style type="text/css">
	.data > table { clear: both; width: 80%; margin: 25px auto; border-top: 1px solid #000; }
	.data > table tr td { padding: 10px 0px; }
	.animation { width: 100%; padding-top: 250px; background: #F8EEB9; }
	.flipsout { align-items: center; vertical-align: middle; text-align: center; width: 100%; margin: 0 auto; height: 100%; display: flex; }
	.inner { margin: 0 auto; position: relative; width:100%; }
	.bushold{ width:425px; margin:0 auto; position:relative;}
	.shadow{ width:65%; height:20px; border-radius:100%; background:rgba(0,0,0,.2); margin:-10px 0 0 30px; z-index:999;}
	.tyreF{ width:60px; height:60px; border-radius:100%; background:#1e2327; position:relative; animation:tyre 1s linear infinite; -webkit-animation:tyre 1s linear infinite; margin-left:50px}
	.tyreF span{width:40px; height:40px; border-radius:100%; background:#aaaaaa; display:block; position:absolute; top:10px; left:10px;}
	.tyreF span i{width:15px; height:15px; border-radius:100%; background:#1e2327; display:block; position:absolute; top:13px; left:13px;}
	.tyreF:after{ border:solid 1px #fff; content:""; position:absolute;}
	.tyreB{ position:absolute; bottom:10px; left:170px;}
	.buspart{ width:60%; margin:0 auto; background:#fbbc05; height:100px; position:absolute; top: -100%; bottom: 0; left: -23%; right: 0; border-radius:20px 50px 5px 5px}
	.buspart:after, .buspart:before{background: #F8EEB9 none repeat scroll 0 0; border-radius: 100%; content: ""; height: 59px; position: absolute; /*right: 42px;*/ right: 10px; top: 64px;width: 66px;}
	.buspart:before{ left: 10px; }
	.busgate{ height:40px; width:20px; background:#fff; position:absolute; right: 80px; top:45px; border-radius:5px;}
	.window, .window:after, .window:before{ width: 50px; height:30px; border-radius:5px; background:#fff; margin:15px 0 0 15px; position:relative;}
	.window:before, .window:after{ content:""; margin:0px; position:absolute; left: 75px; top:0px; }
	.window:after{ left: 175px; border-radius:5px 50px 5px 5px;}
	.road{ width:100%; background:rgba(0,0,0,.6); height: 65px; position:absolute;  top: 25%; border:solid 5px #fff; border-left:0px; border-right:0px; box-shadow:0px 7px 24px -1px rgba(0,0,0,.5) inset; }
	.tree{margin:-230px auto; height:200px; animation:tree 3s linear infinite; -webkit-animation:tree 3s linear infinite; position:absolute;}
	.tree span{ height:200px; width:10px; background:#fbbc05; display:inline-block; vertical-align:middle; margin: 0 90px;}
	.tree span i, .tree span i:after, .tree span i:before{ height:50px; width:50px; background:#34a853; display:block; margin:-10px 0 0 -20px; border-radius:50%; position:relative;}
	.tree span i:after, .tree span i:before{content:""; border-radius:40px 0; position:absolute; left:-12px; top:80px; transform:rotate(80deg); -webkit-transform:rotate(80deg);}
	.tree span i:before{left:50px; top:90px; transform:rotate(-180deg); -webkit- transform:rotate(-180deg);}
	.tree span.treetwo{ margin-top:50px; height:205px;}
	@keyframes tyre{
		0%{ transform:rotate(0deg); }
		100%{ transform:rotate(360deg); }	
	}
	@keyframes tree{
		0%{ right:0px; }
		100%{ right:100%; opacity:0; }	
	}
	#map, #map_canvas {
		width: 500px;
        height: 500px;
        margin: 0 auto;
      }
</style>

<main class="cd-main-content">
	<div class="animation">
		<div class="flipsout">
			<div class="inner">
				<div class="tree"><!--<span><i></i></span>--><span class="treetwo"><i></i></span><!--<span><i></i></span>--></div>
				<div class="road"></div>
				<div class="bushold">
					<div class="buspart">
						<div class="busgate"></div>
						<div class="window"></div>
					</div>
					<div class="tyreF"><span><i></i></span></div>
					<div class="tyreF tyreB"><span><i></i></span></div>
					<div class="shadow"></div>
				</div>
			</div>
		</div>
	</div>

	<div class="data"></div>
</main>




	
	<div id="map"></div>
	<div id="map_canvas"></div>

    <script>
      jQuery(document).ready(function(){

		if( $('.cd-stretchy-nav').length > 0 ) {
			var stretchyNavs = $('.cd-stretchy-nav');
			
			stretchyNavs.each(function(){
				var stretchyNav = $(this),
					stretchyNavTrigger = stretchyNav.find('.cd-nav-trigger');
				
				stretchyNavTrigger.on('click', function(event){
					event.preventDefault();
					stretchyNav.toggleClass('nav-is-visible');
				});
			});

			$(document).on('click', function(event){
				( !$(event.target).is('.cd-nav-trigger') && !$(event.target).is('.cd-nav-trigger span') ) && stretchyNavs.removeClass('nav-is-visible');
			});
		}

		console.log('Ready ...');

		var dateFormat = function () {
			var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
			timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
			timezoneClip = /[^-+\dA-Z]/g,
			pad = function (val, len) {
			    val = String(val);
			    len = len || 2;
			    while (val.length < len) val = "0" + val;
			    return val;
			};

			// Regexes and supporting functions are cached through closure
			return function (date, mask, utc) {
				var dF = dateFormat;

				// You can't provide utc if you skip other args (use the "UTC:" mask prefix)
				if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
				    mask = date;
				    date = undefined;
				}

				// Passing date through Date applies Date.parse, if necessary
				date = date ? new Date(date) : new Date;

				if (isNaN(date)) throw SyntaxError("invalid date");

				mask = String(dF.masks[mask] || mask || dF.masks["default"]);

				// Allow setting the utc argument via the mask
				if (mask.slice(0, 4) == "UTC:") {
				    mask = mask.slice(4);
				    utc = true;
				}

				var _ = utc ? "getUTC" : "get",
				    d = date[_ + "Date"](),
				    D = date[_ + "Day"](),
				    m = date[_ + "Month"](),
				    y = date[_ + "FullYear"](),
				    H = date[_ + "Hours"](),
				    M = date[_ + "Minutes"](),
				    s = date[_ + "Seconds"](),
				    L = date[_ + "Milliseconds"](),
				    o = utc ? 0 : date.getTimezoneOffset(),
				    flags = {
				        d:    d,
				        dd:   pad(d),
				        ddd:  dF.i18n.dayNames[D],
				        dddd: dF.i18n.dayNames[D + 7],
				        m:    m + 1,
				        mm:   pad(m + 1),
				        mmm:  dF.i18n.monthNames[m],
				        mmmm: dF.i18n.monthNames[m + 12],
				        yy:   String(y).slice(2),
				        yyyy: y,
				        h:    H % 12 || 12,
				        hh:   pad(H % 12 || 12),
				        H:    H,
				        HH:   pad(H),
				        M:    M,
				        MM:   pad(M),
				        s:    s,
				        ss:   pad(s),
				        l:    pad(L, 3),
				        L:    pad(L > 99 ? Math.round(L / 10) : L),
				        t:    H < 12 ? "a"  : "p",
				        tt:   H < 12 ? "am" : "pm",
				        T:    H < 12 ? "A"  : "P",
				        TT:   H < 12 ? "AM" : "PM",
				        Z:    utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
				        o:    (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
				        S:    ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
				    };

				return mask.replace(token, function ($0) {
				    return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
				});
			};
		}();

		// Some common format strings
		dateFormat.masks = {
			"default":      "ddd mmm dd yyyy HH:MM:ss",
			shortDate:      "m/d/yy",
			mediumDate:     "mmm d, yyyy",
			longDate:       "mmmm d, yyyy",
			fullDate:       "dddd, mmmm d, yyyy",
			shortTime:      "h:MM TT",
			mediumTime:     "h:MM:ss TT",
			longTime:       "h:MM:ss TT Z",
			isoDate:        "yyyy-mm-dd",
			isoTime:        "HH:MM:ss",
			isoDateTime:    "yyyy-mm-dd'T'HH:MM:ss",
			isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
		};

		// Internationalization strings
		dateFormat.i18n = {
			dayNames: [
				"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
				"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
			],
			monthNames: [
				"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
				"January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
			]
		};

		// For convenience...
		Date.prototype.format = function (mask, utc) {
			return dateFormat(this, mask, utc);
		};

		var allBusStop = []
		,nearestBusStop = []
		,busArrival = []
		,origin = [];
	
		var proxy = 'https://cors-anywhere.herokuapp.com/';

		/*
		var settings = {
			"async": true,
			"crossDomain": true,
			"url": proxy + "http://datamall2.mytransport.sg/ltaodataservice/BusStops",
			"method": "GET",
			"headers": {
				"accountkey": "0TAM+9H4RM6aH0P6Dg9jnA==",
				"accept": "application/json",
				"cache-control": "no-cache"
			}
		}

		$.ajax(settings).done(function (response) {		
			$('.data > table').html('');

			$.each(response.value, function( index, value ) {
			  $('.data > table').append(
			  	'<tr><td>' + 'BusStopCode: ' + value.BusStopCode + '<br />RoadName: ' + value.RoadName + '<br />Description: ' + value.Description + '<br />Latitude: ' + value.Latitude + '<br />Longitude: ' + value.Longitude + '</td></tr>'
			  );
			});
		});
		*/

		/*
		if (navigator.geolocation) {
	        navigator.geolocation.watchPosition(showPosition);
	        console.log('1: ' + navigator.geolocation.watchPosition(showPosition));
	    } else { 
	        alert('Geolocation is not supported by this browser.');
	    }
	    
		function showPosition(position) {
			origin = {"Longitude":position.coords.longitude,"Latitude":position.coords.latitude};
			return origin;
		}
		*/

		$.ajax({
			url: "allBusStop.json",
			dataType: "json",
			success: function (data) {
				getNearestBusStop(data.value);
			}
		});

		function getNearestBusStop(allBusStop) {

			var array = []
				,BusStopCode = []
				,Distance = []
				,RoadName = []
				,Description = [];

			origin = {"Longitude":103.9438054,"Latitude":1.3188777000000003};

			for (var index in allBusStop) {   	
			    var busStopCode = allBusStop[index].BusStopCode;
				var databaseBusStop = {"Longitude": allBusStop[index].Longitude,"Latitude":allBusStop[index].Latitude};
			 	var distance = calculateDistance(origin, databaseBusStop)
			    array.push({
			        BusStopCode: busStopCode,
			        Distance: distance,
					RoadName: allBusStop[index].RoadName,
					Description: allBusStop[index].Description,
			    });
			}

			function calculateDistance(p1, p2) {
			    var erdRadius = 6371;

			    var p1Longitude = p1.Longitude * (Math.PI / 180);
			    var p1Latitude = p1.Latitude * (Math.PI / 180);
			    var p2Longitude = p2.Longitude * (Math.PI / 180);
			    var p2Latitude = p2.Latitude * (Math.PI / 180);

			    var x0 = p1Longitude * erdRadius * Math.cos(p1Latitude);
			    var y0 = p1Latitude * erdRadius;

			    var x1 = p2Longitude * erdRadius * Math.cos(p2Latitude);
			    var y1 = p2Latitude * erdRadius;

			    var dx = x0 - x1;
			    var dy = y0 - y1;

			    return Math.sqrt((dx * dx) + (dy * dy));
			}

			array.sort(function (a, b) {
			    return a.Distance - b.Distance;
			});

			for (var i = 0; i < 20; i++){
				//collect bus stop number within 0.3 meter
				if( array[i].Distance >= 0.3 || i>5 ){
					break;
				}

				nearestBusStop.push(array[i]);
			};

			$('.data').html('');

			$.each(nearestBusStop, function( index, value ) {			
				var settings = {
					"async": true,
					"crossDomain": true,
					"url": proxy + "http://datamall2.mytransport.sg/ltaodataservice/BusArrivalv2?BusStopCode=" + value.BusStopCode,
					"method": "GET",
					"headers": {
						"accountkey": "0TAM+9H4RM6aH0P6Dg9jnA==",
						"accept": "application/json",
						"cache-control": "no-cache"
					}
				}

				$.ajax(settings).done(function (response) {

					console.log(response);
					


					//var busTime = response.Services[0].NextBus.EstimatedArrival;
					/*
					$('.data').append(
						'<table cellspacing="0" cellspacing="0" border="0" align="center"><tr><td colspan="2">Bus Stop: ' + response.BusStopCode + '</td></tr><tr><td colspan="2">Road name: ' + value.RoadName + '<br />Description: ' + value.Description + '<br />Distance: ' + value.Distance + '</td></tr><tr><td>' + dateFormat(new Date(busTime), "mm/dd/yy, h:MM:ss TT") + '</td><td>' + timeToMinute(busTime) + ' Mins </td></tr></table>'
					);
					*/

					$('.data').append('<table class="stop-' + response.BusStopCode + '" cellspacing="0" cellspacing="0" border="0" align="center"><tr><td>Bus Stop: ' + response.BusStopCode + '<br />Road name: ' + value.RoadName + '<br />Description: ' + value.Description + '</td></tr><tr><td class="estimate"></td></tr></table>');

					$.each(response.Services, function( i, v ) {
						$('.stop-' + response.BusStopCode + ' .estimate' ).append('<table cellspacing="0" cellpadding="0" border="0" align="center"><tr><td>Bus No: ' + v.ServiceNo + ' is coming in ' + timeToMinute(v.NextBus.EstimatedArrival) + ' mins</td></tr></table>');
					});
				});
			});	    
		}

		function timeToMinute(arriveTime) {
			var convertArriveTime = new Date(arriveTime);
			var millis =  convertArriveTime- $.now() ;	
		  	var minutes = Math.floor(millis / 60000);
		  	return ((minutes < 0) ? 0 : minutes);;
		}

		var map;
	    var elevator;
	    var myOptions = {
	        zoom: 1,
	        center: new google.maps.LatLng(0, 0),
	        mapTypeId: 'terrain'
	    };

	    map = new google.maps.Map($('#map_canvas')[0], myOptions);

	    var addresses = ['Norway', 'Africa', 'Asia','North America','South America'];


	    for (var i = 0; i < addresses.length; i++) { 
		    console.log(addresses);
		}

		/*
	    for (var x = 0; x < addresses.length; x++ ) {
	        $.getJSON('http://maps.googleapis.com/maps/api/geocode/json?address='+addresses[x]+'&sensor=false', null, function (data) {
	            var p 		= data.results[0].geometry.location;
	            var latlng 	= new google.maps.LatLng(p.lat, p.lng);
	            new google.maps.Marker({
	                position: latlng,
	                map: map
	            });

	        });
	    }
	    */



	/*
	var map, infoWindow;

	function initMap() {

		map = new google.maps.Map(document.getElementById('map'), {
		  center: {lat: -34.397, lng: 150.644},
		  zoom: 18
		});

		infoWindow = new google.maps.InfoWindow;

		// Try HTML5 geolocation.
		if (navigator.geolocation) {
		  navigator.geolocation.getCurrentPosition(function(position) {
		    var pos = {
		      lat: position.coords.latitude,
		      lng: position.coords.longitude
		    };

		    console.log('My lat: ' + position.coords.latitude);
		    console.log('My lng: ' + position.coords.longitude);

		    infoWindow.setPosition(pos);
		    infoWindow.setContent('Location found.');
		    infoWindow.open(map);
		    map.setCenter(pos);

		  }, function() {
		    handleLocationError(true, infoWindow, map.getCenter());
		  });

		} else {
		  // Browser doesn't support Geolocation
		  handleLocationError(false, infoWindow, map.getCenter());
		}
	}

	function handleLocationError(browserHasGeolocation, infoWindow, pos) {
		infoWindow.setPosition(pos);
		infoWindow.setContent(browserHasGeolocation ?
		                      'Error: The Geolocation service failed.' :
		                      'Error: Your browser doesn\'t support geolocation.');
		infoWindow.open(map);
	}
	*/
    </script>
    <!--<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCk6j705ezbnTlbVPEYO78V3qhaJp45p8Q&callback=initMap"></script>-->
    <script src="js/jquery-2.1.4.js"></script>
	<!--<script src="js/main.js"></script>--><!-- Resource jQuery -->
</body>
</html>